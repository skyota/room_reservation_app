{% extends "reservation/base.html" %}

{% block title %}部屋{% endblock title %}

{% block content %}

<h1 class="mt-4">{{ room.name }}</h1>
<ol class="breadcrumb mb-4">
    <li class="breadcrumb-item active"><a href="{% url 'home' %}">ゼミ室一覧</a></li>
    <li class="breadcrumb-item active">{{ room.name }}</li>
</ol>
<div class="mb-5">
    <div id="calendar" data-room-id="{{ room.id }}"></div>
</div>
<div class="row mb-5">
    <div class="col text-end">
        <a href="#" id="cancelBtn" class="btn btn-secondary disabled">予約をキャンセルする</a>
    </div>
    <form class="col" action="" method="POST">
        {% csrf_token %}
        <button id="confirmBtn" type="submit" class="btn btn-primary disabled">予約を確認する</button>
    </form>
</div>            

{% endblock content %}

{% block script %}

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script>
    const csrfToken = "{{ csrf_token }}";

    axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";
    axios.defaults.xsrfCookieName = "csrftoken";
    axios.defaults.headers.common['X-CSRFTOKEN'] = csrfToken;

    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var roomId = calendarEl.getAttribute('data-room-id');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            allDaySlot: false,
            height: 500,
            timeZone: 'Asia/Tokyo',
            locale: 'ja',
            buttonText: {
                    today:    '今日',
            },
            slotMinTime: '08:00:00',
            slotMaxTime: '19:00:00',
            slotDuration: '00:30:00',
            selectable: true,
            selectOverlap: false,
            select: function(info) {
                const reservationTitle = prompt('使用用途を入力してください。');
                if (reservationTitle) {
                    axios.post(`/room/${roomId}/add_reservation/`, {
                        title: reservationTitle,
                        start_date: info.start.toISOString(), 
                        end_date: info.end.toISOString()
                    })
                    .then(function(response) {
                        calendar.addEvent({
                            title: reservationTitle,
                            start: info.start,
                            end: info.end,
                        });
                        alert("予約が正常に登録されました。");
                    })
                    .catch(function(error) {
                        alert("予約の登録に失敗しました。");
                    });
                };
            },

            events: function (info, successCallback, failureCallback) {
                axios.get(`/room/${roomId}/list/`, {
                    params: {
                        start_date: info.start.toISOString(),
                        end_date: info.end.toISOString(),
                },
                })
                .then((response) => {
                    successCallback(response.data);
                })
                .catch(() => {
                    alert("予約データの取得に失敗しました");
                    failureCallback();
                });
            },

        });
        calendar.render();
    });
</script>

{% endblock script %}
